from bs4 import BeautifulSoup
import unittest

import search


class TestSearch(unittest.TestCase):
    def test_build_request(self):
        url = 'https://abc.com'
        params = dict(cool=123)
        full_url = f'{url}?cool=123'
        r = search.build_request(url, params)
        self.assertEqual(r.full_url, full_url)
        self.assertIn('User-agent', r.headers)

    def test_extract_result_without_filetype(self):
        g = BeautifulSoup("""<div class="g"><!--m--><div data-hveid="CAgQAA" data-ved="2ahUKEwi7lKGLwrTnAhUQ2FkKHTvICz4QFSgAMAN6BAgIEAA"><div class="rc"><div class="r"><a href="https://www.youtube.com/Google" onmousedown="return rwt(this,'','','','4','AOvVaw1oc7jWhH1lF0X-x9PiZjLt','','2ahUKEwi7lKGLwrTnAhUQ2FkKHTvICz4QFjADegQICBAB','','',event)"><div class="TbwUpd"><cite class="iUh30 bc">www.youtube.com › Google</cite></div><br><h3 class="LC20lb">Google - YouTube</h3></a><div class="B6fmyf"><div class="TbwUpd"><cite class="iUh30 bc">www.youtube.com › Google</cite></div><div class="yWc32e"><span><div class="action-menu ab_ctl"><a class="GHDvEf ab_button" href="#" id="am-b3" aria-label="Opciones de resultados" aria-expanded="false" aria-haspopup="true" role="button" jsaction="m.tdd;keydown:m.hbke;keypress:m.mskpe" data-ved="2ahUKEwi7lKGLwrTnAhUQ2FkKHTvICz4Q7B0wA3oECAgQBA"><span class="mn-dwn-arw"></span></a><div class="action-menu-panel ab_dropdown" role="menu" tabindex="-1" jsaction="keydown:m.hdke;mouseover:m.hdhne;mouseout:m.hdhue" data-ved="2ahUKEwi7lKGLwrTnAhUQ2FkKHTvICz4QqR8wA3oECAgQBQ"><ol><li class="action-menu-item ab_dropdownitem" role="menuitem"><a class="fl" href="https://webcache.googleusercontent.com/search?q=cache:bDiEYDIivakJ:https://www.youtube.com/Google+&amp;cd=4&amp;hl=es-419&amp;ct=clnk&amp;gl=sv&amp;client=firefox-b-d" onmousedown="return rwt(this,'','','','4','AOvVaw0v1ofW2kzEkZoGLgEns4Lq','','2ahUKEwi7lKGLwrTnAhUQ2FkKHTvICz4QIDADegQICBAG','','',event)">En&nbsp;caché</a></li></ol></div></div></span><a class="fl" href="https://translate.google.com/translate?hl=es-419&amp;sl=en&amp;u=https://www.youtube.com/Google&amp;prev=search" onmousedown="return rwt(this,'','','','4','AOvVaw1NrL2GpL6Drf1NhI5PPS_-','','2ahUKEwi7lKGLwrTnAhUQ2FkKHTvICz4Q7gEwA3oECAgQCA','','',event)">Traducir esta página</a></div></div></div><div class="s"><div><span class="st">Experience the world of <em>Google</em> on our official YouTube channel. Watch videos about our products, technology, company happenings and more. Subscribe to&nbsp;...</span></div></div><div data-base-uri="/search?client=firefox-b-d" id="ed_13" data-ved="2ahUKEwi7lKGLwrTnAhUQ2FkKHTvICz4Q2Z0BMAN6BAgIEAk"><div jsname="UTgHCf" class="AUiS2" data-ved="2ahUKEwjL15mMwrTnAhWExVkKHV62CuQQx40DegQIARAA"><div jsname="d3PE6e" style="display:none"><div data-ved="2ahUKEwjL15mMwrTnAhWExVkKHV62CuQQsKwBKAB6BAgBEAE">youtube search</div><div data-ved="2ahUKEwjL15mMwrTnAhWExVkKHV62CuQQsKwBKAF6BAgBEAI">youtube videos google</div><div data-ved="2ahUKEwjL15mMwrTnAhWExVkKHV62CuQQsKwBKAJ6BAgBEAM">google colombia</div><div data-ved="2ahUKEwjL15mMwrTnAhWExVkKHV62CuQQsKwBKAN6BAgBEAQ">youtube :)</div><div data-ved="2ahUKEwjL15mMwrTnAhWExVkKHV62CuQQsKwBKAR6BAgBEAU">you tu be video</div><div data-ved="2ahUKEwjL15mMwrTnAhWExVkKHV62CuQQsKwBKAV6BAgBEAY">google colombia youtube</div></div><span jsname="ZnuYW" class="XCKyNd" aria-label="Descartar seguimientos sugeridos" role="button" tabindex="0"></span><div><div jsname="l1CLDf" class="d8lLoc"><h4 jsname="IaVMje" class="eJ7tvc">Otras personas también buscaron</h4><div jsname="CeevUc" class="hYkSRb"></div></div></div></div></div></div></div><!--n--></div>""", 'html.parser')
        expected = {
            'href': 'https://www.youtube.com/Google',
            'title': 'Google - YouTube',
            'breadcrumbs': 'www.youtube.com › Google',
            'description': 'Experience the world of Google on our official YouTube channel. Watch videos about our products, technology, company happenings and more. Subscribe to\xa0...',
        }
        result = search.extract_result(g)
        self.assertDictEqual(result, expected)

    def test_extract_result_with_filetype(self):
        g = BeautifulSoup("""<div class="g"><!--m--><div data-hveid="CAQQAA" data-ved="2ahUKEwjN4bCdxbTnAhVkS98KHV7aAEMQFSgAMAF6BAgEEAA"><div class="rc"><div class="r" style="white-space:nowrap"><a href="https://guidelines.raterhub.com/searchqualityevaluatorguidelines.pdf" onmousedown="return rwt(this,'','','','2','AOvVaw31EySDXSGg9QT5qzSmjpmq','','2ahUKEwjN4bCdxbTnAhVkS98KHV7aAEMQFjABegQIBBAB','','',event)"><div class="TbwUpd"><cite class="iUh30 bc">guidelines.raterhub.com › searchqualityevaluatorguidelines</cite></div><br><h3 class="LC20lb">Guidelines - Raterhub.com</h3></a><div class="B6fmyf"><div class="TbwUpd"><cite class="iUh30 bc">guidelines.raterhub.com › searchqualityevaluatorguidelines</cite></div><div class="yWc32e"><span class="sFZIhb b w xsm">PDF</span></div></div></div><div class="s"><div><span class="st"><span class="f">5 dic. 2019 - </span><em>Google's</em> advanced search option. 0.2 Raters Must Represent People in their Rating Locale. It is very important for you to represent people in&nbsp;...</span></div></div></div></div><!--n--></div>""", 'html.parser')
        expected = {
            'href': 'https://guidelines.raterhub.com/searchqualityevaluatorguidelines.pdf',
            'title': 'Guidelines - Raterhub.com',
            'breadcrumbs': 'guidelines.raterhub.com › searchqualityevaluatorguidelines',
            'description': "5 dic. 2019 - Google's advanced search option. 0.2 Raters Must Represent People in their Rating Locale. It is very important for you to represent people in\xa0...",
            'filetype': 'PDF',
        }
        result = search.extract_result(g)
        self.assertDictEqual(result, expected)

    def test_extract_results(self):
        srg_soup = BeautifulSoup("""<div class="srg"><div class="g"><!--m--><div data-hveid="CAEQAA" data-ved="2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQFSgAMAB6BAgBEAA"><div class="rc"><div class="r" style="white-space:nowrap"><a href="http://www.sld.cu/galerias/pdf/sitios/bmn/aprenda_a_buscar_en_google_1.pdf" onmousedown="return rwt(this,'','','','1','AOvVaw1FHjn_YLFnln8EeaYK7M7Q','','2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQFjAAegQIARAB','','',event)"><div class="TbwUpd"><cite class="iUh30 bc">www.sld.cu › galerias › pdf › sitios › bmn › aprenda_a_buscar_en_g...</cite></div><br><h3 class="LC20lb">Aprenda a buscar en Google</h3></a><div class="B6fmyf"><div class="TbwUpd"><cite class="iUh30 bc">www.sld.cu › galerias › pdf › sitios › bmn › aprenda_a_buscar_en_g...</cite></div><div class="yWc32e"><span><div class="action-menu ab_ctl"><a class="GHDvEf ab_button" href="#" id="am-b0" aria-label="Opciones de resultados" aria-expanded="false" aria-haspopup="true" role="button" jsaction="m.tdd;keydown:m.hbke;keypress:m.mskpe" data-ved="2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQ7B0wAHoECAEQBA"><span class="mn-dwn-arw"></span></a><div class="action-menu-panel ab_dropdown" role="menu" tabindex="-1" jsaction="keydown:m.hdke;mouseover:m.hdhne;mouseout:m.hdhue" data-ved="2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQqR8wAHoECAEQBQ"><ol><li class="action-menu-item ab_dropdownitem" role="menuitem"><a class="fl" href="http://webcache.googleusercontent.com/search?q=cache:86aGyWfDW8wJ:www.sld.cu/galerias/pdf/sitios/bmn/aprenda_a_buscar_en_google_1.pdf+&amp;cd=1&amp;hl=es-419&amp;ct=clnk&amp;gl=sv&amp;client=firefox-b-d" onmousedown="return rwt(this,'','','','1','AOvVaw1N1XPdCAHngACYU8jcJtYK','','2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQIDAAegQIARAG','','',event)">En&nbsp;caché</a></li><li class="action-menu-item ab_dropdownitem" role="menuitem"><a class="fl" href="/search?client=firefox-b-d&amp;q=related:www.sld.cu/galerias/pdf/sitios/bmn/aprenda_a_buscar_en_google_1.pdf&amp;tbo=1&amp;sa=X&amp;ved=2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQHzAAegQIARAH">Similares</a></li></ol></div></div></span><span class="sFZIhb b w xsm">PDF</span></div></div></div><div class="s"><div><span class="st">Búsqueda básica. Para ingresar una consulta en <em>Google</em>, simplemente tipee algunas palabras descriptivas y presione la tecla “Intro” (o haga clic en el botón de&nbsp;...</span></div></div><div data-base-uri="/search?num=2&amp;client=firefox-b-d" id="ed_3" data-ved="2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQ2Z0BMAB6BAgBEAk"><div jsname="UTgHCf" class="AUiS2" data-ved="2ahUKEwie2dSpxrTnAhUS01kKHR8KA8wQx40DegQIABAA"><div jsname="d3PE6e" style="display:none"><div data-ved="2ahUKEwie2dSpxrTnAhUS01kKHR8KA8wQsKwBKAB6BAgAEAE">comandos de google pdf</div><div data-ved="2ahUKEwie2dSpxrTnAhUS01kKHR8KA8wQsKwBKAF6BAgAEAI">filetype doc</div><div data-ved="2ahUKEwie2dSpxrTnAhUS01kKHR8KA8wQsKwBKAJ6BAgAEAM">operadores booleanos google academico</div><div data-ved="2ahUKEwie2dSpxrTnAhUS01kKHR8KA8wQsKwBKAN6BAgAEAQ">como buscar un libro sin saber el nombre</div><div data-ved="2ahUKEwie2dSpxrTnAhUS01kKHR8KA8wQsKwBKAR6BAgAEAU">busqueda avanzada google</div><div data-ved="2ahUKEwie2dSpxrTnAhUS01kKHR8KA8wQsKwBKAV6BAgAEAY">zerg rush</div></div><span jsname="ZnuYW" class="XCKyNd" aria-label="Descartar seguimientos sugeridos" role="button" tabindex="0"></span><div><div jsname="l1CLDf" class="d8lLoc"><h4 jsname="IaVMje" class="eJ7tvc">Otras personas también buscaron</h4><div jsname="CeevUc" class="hYkSRb"></div></div></div></div></div></div></div><!--n--></div><div class="g"><!--m--><div data-hveid="CAIQAA" data-ved="2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQFSgAMAF6BAgCEAA"><div class="rc"><div class="r" style="white-space:nowrap"><a href="https://mastermarketingdigital.org/Toreando-a-Google-Ricardo-Carreras.pdf" onmousedown="return rwt(this,'','','','2','AOvVaw0UHTZ1emUvTnU1bcjjRVOq','','2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQFjABegQIAhAB','','',event)"><div class="TbwUpd"><cite class="iUh30 bc">mastermarketingdigital.org › Toreando-a-Google-Ricardo-Carreras</cite></div><br><h3 class="LC20lb">Toreando a Google - Máster en Marketing Digital</h3></a><div class="B6fmyf"><div class="TbwUpd"><cite class="iUh30 bc">mastermarketingdigital.org › Toreando-a-Google-Ricardo-Carreras</cite></div><div class="yWc32e"><span><div class="action-menu ab_ctl"><a class="GHDvEf ab_button" href="#" id="am-b1" aria-label="Opciones de resultados" aria-expanded="false" aria-haspopup="true" role="button" jsaction="m.tdd;keydown:m.hbke;keypress:m.mskpe" data-ved="2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQ7B0wAXoECAIQBA"><span class="mn-dwn-arw"></span></a><div class="action-menu-panel ab_dropdown" role="menu" tabindex="-1" jsaction="keydown:m.hdke;mouseover:m.hdhne;mouseout:m.hdhue" data-ved="2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQqR8wAXoECAIQBQ"><ol><li class="action-menu-item ab_dropdownitem" role="menuitem"><a class="fl" href="https://webcache.googleusercontent.com/search?q=cache:06UBmqrgIu4J:https://mastermarketingdigital.org/Toreando-a-Google-Ricardo-Carreras.pdf+&amp;cd=2&amp;hl=es-419&amp;ct=clnk&amp;gl=sv&amp;client=firefox-b-d" onmousedown="return rwt(this,'','','','2','AOvVaw2u5KrKilVLATIZIv2dc44M','','2ahUKEwjqprSoxrTnAhXSnuAKHQpPCtwQIDABegQIAhAG','','',event)">En&nbsp;caché</a></li></ol></div></div></span><span class="sFZIhb b w xsm">PDF</span></div></div></div><div class="s"><div><span class="st">Toreando a <em>Google</em>, basado en la tesis doctoral del autor, estudia en profundidad cómo funciona <em>Google</em>, y cómo triunfar en los resultados del buscador, cuya&nbsp;...</span></div></div></div></div><!--n--></div></div>""", 'html.parser')
        results = search.extract_results(srg_soup)
        self.assertEqual(len(results), 2)

    def test_online_search(self):
        results = search.search('keystone - Circular reference found role inference')
        self.assertEqual(len(results), 5)
